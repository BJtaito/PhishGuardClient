<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Phish-Guard ë¶„ì„ ì½˜ì†”</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        margin: 0;
        padding: 0;
      }
      .wrap {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 16px 40px;
      }
      h1 {
        font-size: 26px;
        margin-bottom: 6px;
      }
      .subtitle {
        color: #9ca3af;
        margin-bottom: 24px;
        font-size: 13px;
      }
      .card {
        background: #020617;
        border-radius: 12px;
        padding: 16px 18px;
        border: 1px solid #1f2937;
        margin-bottom: 16px;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .card-title {
        font-weight: 600;
        font-size: 15px;
      }
      .pill {
        border-radius: 999px;
        padding: 3px 10px;
        font-size: 11px;
        border: 1px solid #374151;
        color: #d1d5db;
      }
      .pill.low {
        border-color: #10b981;
        color: #a7f3d0;
      }
      .pill.mid {
        border-color: #f59e0b;
        color: #fde68a;
      }
      .pill.high {
        border-color: #ef4444;
        color: #fecaca;
      }
      .pill.small-pill {
        padding: 2px 8px;
        font-size: 10px;
      }
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #374151;
        padding: 8px 10px;
        background: #020617;
        color: #e5e7eb;
        font-size: 14px;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #1d4ed8;
      }
      button {
        border-radius: 8px;
        border: none;
        padding: 8px 14px;
        background: #3b82f6;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .row > div {
        flex: 1 1 0;
        min-width: 0;
      }
      .score-main {
        font-size: 28px;
        font-weight: 700;
      }
      .score-sub {
        font-size: 12px;
        color: #9ca3af;
      }
      .kv {
        font-size: 13px;
        margin-top: 3px;
      }
      .kv span.key {
        color: #9ca3af;
      }
      .kv span.val {
        color: #e5e7eb;
        margin-left: 4px;
      }
      ul.reasons {
        list-style: none;
        padding-left: 0;
        margin: 6px 0 0;
        font-size: 13px;
        max-height: 260px;
        overflow-y: auto;
      }
      ul.reasons li {
        padding: 4px 0;
        border-bottom: 1px solid #111827;
      }
      .feature {
        color: #9ca3af;
        font-size: 11px;
        text-transform: uppercase;
      }
      .reason-detail {
        font-size: 13px;
      }
      .score-chip {
        font-size: 11px;
        color: #d1d5db;
      }
      .foot {
        margin-top: 16px;
        font-size: 11px;
        color: #6b7280;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        background: #020617;
        padding: 2px 4px;
        border-radius: 4px;
      }
      .small {
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      /* ë‹¤ìš´ë¡œë“œ í…Œì´ë¸” */
      .dl-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 12px;
      }
      .dl-table th,
      .dl-table td {
        padding: 4px 6px;
        border-bottom: 1px solid #111827;
        text-align: left;
        vertical-align: middle;
      }
      .dl-table th {
        color: #9ca3af;
        font-weight: 500;
        font-size: 11px;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Phish-Guard URL ë¶„ì„</h1>
      <div class="subtitle">
        ìì²´ ì •ì /ë™ì  ë¶„ì„ + ML +
        <span style="color:#60a5fa;">VirusTotal í‰íŒ</span>ì„ ì¡°í•©í•œ PoC ì½˜ì†”ì…ë‹ˆë‹¤.
      </div>

      <!-- ì…ë ¥ ì¹´ë“œ -->
      <div class="card">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
          <input
            id="urlInput"
            type="text"
            placeholder="ë¶„ì„í•  URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://example.com)"
          />
          <button id="analyzeBtn">ë¶„ì„</button>
        </div>
        <div class="small" style="color:#9ca3af;">
          ê¸°ë³¸ API í‚¤ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. ì‹¤ì œ ì„œë²„ì˜ <code>API_KEYS</code> í™˜ê²½ ë³€ìˆ˜ì—
          ë§ê²Œ JS ìƒë‹¨ì˜ <code>API_KEY</code> ê°’ì„ ë³€ê²½í•˜ì„¸ìš”.
        </div>
      </div>

      <div id="resultArea" style="display:none;">
        <!-- ìš”ì•½ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ìš”ì•½</div>
            <span id="riskPill" class="pill">-</span>
          </div>
          <div class="row">
            <div>
              <div class="score-main" id="scoreMain">-</div>
              <div class="score-sub" id="scoreSub">Score / 100</div>
            </div>
            <div>
              <div class="kv">
                <span class="key">ì—”ì§„:</span>
                <span class="val" id="engineName">-</span>
              </div>
              <div class="kv">
                <span class="key">ML:</span>
                <span class="val" id="mlInfo">-</span>
              </div>
              <div class="kv">
                <span class="key">HTTP ìƒíƒœ:</span>
                <span class="val" id="httpStatus">-</span>
              </div>
              <div class="kv">
                <span class="key">ë‹¤ìš´ë¡œë“œ ë¶„ì„:</span>
                <span class="val" id="dlStatus">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- VirusTotal (URL í‰íŒ) -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">VirusTotal</div>
            <span class="pill" id="vtPill">ì •ë³´ ì—†ìŒ</span>
          </div>
          <div id="vtBody" class="small">
            VirusTotal ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>

        <!-- ë‹¤ìš´ë¡œë“œ / íŒŒì¼ ë¶„ì„ -->
        <div class="card" id="downloadsCard" style="display:none;">
          <div class="card-header">
            <div class="card-title">ë‹¤ìš´ë¡œë“œ / íŒŒì¼ ë¶„ì„</div>
            <span class="pill" id="dlPill">-</span>
          </div>
          <div id="downloadsBody" class="small">
            ë‹¤ìš´ë¡œë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>

        <!-- ë£° & í”¼ì²˜ / ì´ìœ  -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ë£° & í”¼ì²˜</div>
            <span class="pill">Rules / ML / VT ì¡°í•©</span>
          </div>
          <ul class="reasons" id="reasonList"></ul>
        </div>
      </div>

      <div class="foot">
        ì„œë²„ ì—”ë“œí¬ì¸íŠ¸:
        <code>/analyze</code> â†’ <code>/tasks/&lt;id&gt;</code>
        (í˜„ì¬ í˜ì´ì§€ëŠ” PoCìš© UIì…ë‹ˆë‹¤.)
      </div>
    </div>

    <script>
      const API_KEY = "dev-key-123"; // ğŸ”¹ ì‹¤ì œ API í‚¤ì— ë§ê²Œ ìˆ˜ì •

      const urlInput = document.getElementById("urlInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const resultArea = document.getElementById("resultArea");
      const scoreMain = document.getElementById("scoreMain");
      const scoreSub = document.getElementById("scoreSub");
      const riskPill = document.getElementById("riskPill");
      const engineName = document.getElementById("engineName");
      const mlInfo = document.getElementById("mlInfo");
      const httpStatus = document.getElementById("httpStatus");
      const dlStatus = document.getElementById("dlStatus");
      const vtPill = document.getElementById("vtPill");
      const vtBody = document.getElementById("vtBody");
      const reasonList = document.getElementById("reasonList");

      const downloadsCard = document.getElementById("downloadsCard");
      const downloadsBody = document.getElementById("downloadsBody");
      const dlPill = document.getElementById("dlPill");

      function setRiskPill(score) {
        let lvl = "ì •ìƒ (Low)";
        let cls = "low";
        if (score >= 70) {
          lvl = "ìœ„í—˜ (High)";
          cls = "high";
        } else if (score >= 30) {
          lvl = "ì£¼ì˜ (Medium)";
          cls = "mid";
        }
        riskPill.textContent = `${lvl}`;
        riskPill.className = `pill ${cls}`;
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€ VirusTotal URL í‘œê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderVT(vt) {
        if (!vt || vt.error) {
          vtPill.textContent = "ì •ë³´ ì—†ìŒ";
          vtPill.className = "pill";
          vtBody.textContent = vt && vt.error
            ? `VirusTotal ì˜¤ë¥˜: ${vt.error}`
            : "VirusTotal ë ˆí¬íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
          return;
        }
        if (!vt.found) {
          vtPill.textContent = "ë¯¸ë“±ë¡ URL";
          vtPill.className = "pill";
          vtBody.textContent =
            "ì´ URLì€ VirusTotalì— ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (ë¶„ì„ ìš”ì²­ì´ ì—†ì—ˆê±°ë‚˜ ìºì‹œê°€ ì—†ìŒ).";
          return;
        }

        const mal = vt.malicious || 0;
        const engines = vt.total_engines || 0;
        const ratio = vt.ratio != null ? vt.ratio : 0;

        // ğŸ”¹ ì—¬ê¸°ì„œëŠ” â€œì •ìƒ/ì£¼ì˜/ê²½ê³ â€ ë¼ë²¨ ëŒ€ì‹ , ì—”ì§„ ìˆ˜ / ë¹„ìœ¨ë§Œ ì¶œë ¥
        vtPill.textContent = `${mal} / ${engines} ì—”ì§„ ê°ì§€`;
        vtPill.className = "pill";

        vtBody.innerHTML = `
          <div class="kv">
            <span class="key">ê°ì§€ ì—”ì§„ ìˆ˜:</span>
            <span class="val">${mal} / ${engines}</span>
          </div>
          <div class="kv">
            <span class="key">ë¹„ìœ¨:</span>
            <span class="val">${ratio}</span>
          </div>
        `;
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë‹¤ìš´ë¡œë“œ / íŒŒì¼ ë¶„ì„ ì„¹ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderDownloadsSection(feats) {
        if (!downloadsCard || !downloadsBody || !dlPill) return;

        const dl = feats.downloads;
        if (!dl) {
          downloadsCard.style.display = "none";
          return;
        }

        downloadsCard.style.display = "block";

        if (dl.error) {
          dlPill.textContent = "ì˜¤ë¥˜";
          dlPill.className = "pill mid";
          downloadsBody.textContent = `ë‹¤ìš´ë¡œë“œ ë¶„ì„ ì˜¤ë¥˜: ${dl.error}`;
          return;
        }

        const list = Array.isArray(dl.downloads) ? dl.downloads : [];
        const count = dl.download_count ?? list.length ?? 0;
        const maxRiskRaw =
          dl.max_risk_score != null ? Number(dl.max_risk_score) : null;
        const maxRisk =
          maxRiskRaw != null && !Number.isNaN(maxRiskRaw)
            ? maxRiskRaw
            : null;
        const summaryLine = dl.summary_line || "";

        // ìƒë‹¨ pill
        if (!count) {
          dlPill.textContent = "íŒŒì¼ ì—†ìŒ";
          dlPill.className = "pill";
        } else {
          if (maxRisk == null) {
            dlPill.textContent = `íŒŒì¼ ${count}ê°œ`;
            dlPill.className = "pill";
          } else if (maxRisk >= 70) {
            dlPill.textContent = `ìœ„í—˜ (ìµœê³  ${maxRisk.toFixed(1)}%)`;
            dlPill.className = "pill high";
          } else if (maxRisk >= 30) {
            dlPill.textContent = `ì£¼ì˜ (ìµœê³  ${maxRisk.toFixed(1)}%)`;
            dlPill.className = "pill mid";
          } else {
            dlPill.textContent = `ë‚®ìŒ (ìµœê³  ${maxRisk.toFixed(1)}%)`;
            dlPill.className = "pill low";
          }
        }

        let html = `
          <div class="kv">
            <span class="key">íŒŒì¼ ìˆ˜:</span>
            <span class="val">${count}</span>
          </div>
          <div class="kv">
            <span class="key">ìµœê³  ìœ„í—˜ë„:</span>
            <span class="val">${
              maxRisk != null ? maxRisk.toFixed(1) + "%" : "-"
            }</span>
          </div>
        `;

        if (summaryLine) {
          html += `<div class="small" style="margin-top:4px;">${summaryLine}</div>`;
        }

        if (count > 0) {
          html += `
            <table class="dl-table">
              <thead>
                <tr>
                  <th>íŒŒì¼ëª…</th>
                  <th>í¬ê¸°</th>
                  <th>ìœ„í—˜ë„</th>
                </tr>
              </thead>
              <tbody>
          `;
          for (const d of list) {
            const path = (d.saved_path || "").toString();
            const name =
              d.filename ||
              d.name ||
              (path ? path.split(/[\\/]/).pop() : "-") ||
              "-";

            const sizeBytes =
              d.size_bytes != null
                ? Number(d.size_bytes)
                : d.size != null
                ? Number(d.size)
                : null;
            let sizeText = "-";
            if (sizeBytes != null && !Number.isNaN(sizeBytes)) {
              if (sizeBytes >= 1024 * 1024) {
                sizeText = (sizeBytes / (1024 * 1024)).toFixed(1) + " MB";
              } else if (sizeBytes >= 1024) {
                sizeText = (sizeBytes / 1024).toFixed(1) + " KB";
              } else {
                sizeText = sizeBytes + " B";
              }
            }

            const vtSum = d.vt_summary || d.vt || {};
            const riskRaw =
              vtSum.risk_score_percent != null
                ? Number(vtSum.risk_score_percent)
                : null;
            let riskHtml = "<span class='small'>ì •ë³´ ì—†ìŒ</span>";
            if (riskRaw != null && !Number.isNaN(riskRaw)) {
              let label = "Low";
              let cls = "pill low small-pill";
              if (riskRaw >= 70) {
                label = "High";
                cls = "pill high small-pill";
              } else if (riskRaw >= 30) {
                label = "Medium";
                cls = "pill mid small-pill";
              }
              riskHtml = `<span class="${cls}">${riskRaw.toFixed(
                1
              )}% ${label}</span>`;
            }

            html += `
              <tr>
                <td>${name}</td>
                <td>${sizeText}</td>
                <td>${riskHtml}</td>
              </tr>
            `;
          }
          html += "</tbody></table>";
        }

        downloadsBody.innerHTML = html;
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë£° / ì´ìœ  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderReasons(result) {
        reasonList.innerHTML = "";
        const reasons = result.reasons || [];
        if (!reasons.length) {
          const li = document.createElement("li");
          li.textContent = "ë£° ê¸°ë°˜ íŠ¹ì§•ì´ ì—†ìŠµë‹ˆë‹¤.";
          reasonList.appendChild(li);
          return;
        }
        for (const r of reasons) {
          const li = document.createElement("li");
          const feat = (r.feature || "").toString();
          const detail = (r.detail || "").toString();
          const sc = r.score != null ? r.score : null;
          li.innerHTML = `
            <div class="feature">${feat}</div>
            <div class="reason-detail">${detail}</div>
            ${
              sc !== null
                ? `<div class="score-chip">+${sc}</div>`
                : ""
            }
          `;
          reasonList.appendChild(li);
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìµœì¢… ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderResult(task) {
        const result = task.result || {};
        const score =
          result.risk_score_100 ??
          result.risk_score ??
          (result.risk_score_norm != null
            ? result.risk_score_norm * 100
            : 0);
        const sInt = Math.round(score);

        resultArea.style.display = "block";
        scoreMain.textContent = sInt;
        scoreSub.textContent = `Score / ${result.score_scale || 100}`;
        setRiskPill(sInt);

        engineName.textContent = result.engine || "quick-rules";

        const feats = result.features || {};
        const ml = feats.ml || {};
        if (ml.prob != null) {
          mlInfo.textContent = `p=${ml.prob} (rules_norm=${ml.rules_norm}, w=${ml.weight_rules})`;
        } else {
          mlInfo.textContent = "ML ì •ë³´ ì—†ìŒ";
        }

        const hs = feats.http_status;
        if (hs == null) {
          httpStatus.textContent = "ì•Œ ìˆ˜ ì—†ìŒ";
        } else if (hs === 403 || hs === 404) {
          httpStatus.textContent = `${hs} (ì ‘ì† ë¶ˆê°€ / ì°¨ë‹¨ ë˜ëŠ” ì—†ìŒ)`;
        } else {
          httpStatus.textContent = `${hs} (ì‘ë‹µ ìˆìŒ)`;
        }

        const dlSummary = feats.downloads_summary || {};
        if (!dlSummary.enabled) {
          dlStatus.textContent = "ë¹„í™œì„±í™”ë¨";
        } else if (!dlSummary.ran) {
          dlStatus.textContent = "ì‹œë„ ì‹¤íŒ¨ ë˜ëŠ” ì‹¤í–‰ ì•ˆ ë¨";
        } else {
          dlStatus.textContent = `ì‹¤í–‰ë¨ / íŒŒì¼ ìˆ˜: ${
            dlSummary.download_count || 0
          }`;
        }

        renderVT(feats.virustotal);
        renderDownloadsSection(feats); // ğŸ”¹ ì—¬ê¸°ì„œ ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ ë Œë”
        renderReasons(result);
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€ analyze / polling â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function analyze(url) {
        analyzeBtn.disabled = true;
        resultArea.style.display = "none";
        try {
          const resp = await fetch("/analyze", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": API_KEY,
            },
            body: JSON.stringify({ url }),
          });
          if (!resp.ok) {
            const text = await resp.text();
            alert("ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: " + text);
            return;
          }
          const data = await resp.json();
          const taskId = data.task_id;
          await pollTask(taskId);
        } catch (e) {
          alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + e);
        } finally {
          analyzeBtn.disabled = false;
        }
      }

      async function pollTask(taskId) {
        while (true) {
          const resp = await fetch(`/tasks/${taskId}?verbose=0`, {
            headers: { "X-API-Key": API_KEY },
          });
          if (!resp.ok) {
            const t = await resp.text();
            throw new Error("task ì¡°íšŒ ì‹¤íŒ¨: " + t);
          }
          const data = await resp.json();
          if (data.status === "done") {
            renderResult(data);
            return;
          }
          await new Promise((r) => setTimeout(r, 800));
        }
      }

      analyzeBtn.addEventListener("click", () => {
        const url = urlInput.value.trim();
        if (!url) {
          alert("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        analyze(url);
      });

      urlInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          analyzeBtn.click();
        }
      });
    </script>
  </body>
</html>
